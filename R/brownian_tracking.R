################################################################################
# Importing the data

Data <- read.table(paste(getwd(),'/CDNOW_sample.txt',sep=''), header=FALSE, sep="")
names(Data) <- c("master_id", "id", "day", "amount", "dollar_amount")
Data$day <- as.Date(as.character(Data$day), "%Y%m%d")
Data$day <- as.numeric(Data$day - min(Data$day))/7

# Get the number of consumers.
num_ids <- Data[nrow(Data),2]

################################################################################

# Parameters for the simulation.
NN = 100
sigma = 1
dt = 1

# Total recorded period.
tol_period <- 78

# TTT vector stores the amount of time for each consumer from joining the firm to the end of 39 weeks calibration period.
TTT <- c()

for(i in 1:num_ids){
  id_Data <- Data[Data$id == i,]
  TTT[i] <- tol_period - id_Data$day[1] + 1
}

################################################################################
# Generate N Brownian motions dv_t = sigma*dW_t starting from zero over the time interval [0,TT] with step size dt.

Gen_Brownian_Motions <- function(NN, sigma, TT, dt) {
  num_steps_ <- as.integer(round(TT/dt))
  v_list <- array(0, dim=c(NN, num_steps_))
  min_v_list <- array(0, dim=c(NN, num_steps_))
  for (j in 1:NN) {
    for (i in 2:num_steps_) {
      v_list[j,i] <- rnorm(1, v_list[j,i-1], sigma*sqrt(dt))
      min_v_list[j,i] <- min(v_list[j,1:i])
    }
  }
  v_df <- as.data.frame(v_list)
  min_v_df <- as.data.frame(min_v_list)
  # We are ignoring the first time frame (t = 0) since all Brownian motions starts at v = 0.
  v_df <- v_df[2:ncol(v_df)]
  min_v_df <- min_v_df[2:ncol(min_v_df)]
  
  return_df <- list(v_df, min_v_df)
  return(return_df)
}

################################################################################
# We re-adjust data format to be more suitable for the Brownian motion simulation here.

# number of steps of Brownian motion on the entire recorded period.
num_steps <- as.integer(round(tol_period/dt))

# Dataframe to store the simulated Brownian motions for all consumers.
v_df <- data.frame(matrix(ncol = num_steps, nrow = 0))
# Dataframe to store the minimum of the simulated Brownian motions for all consumers. 
min_v_df <- data.frame(matrix(ncol = num_steps, nrow = 0))

# To construct each dataframe above by concatenating smaller dataframes,is faster to put all the smaller dataframes in a list first before before applying bind_rows. 
v_df_ <- list()
min_v_df_ <- list()

for (i in 1:num_ids) {
  print(paste("Simulating id = ", as.character(i)))
  TT <- as.integer(round(TTT[i]/dt))-1
  
  returned_df <- Gen_Brownian_Motions(NN, sigma, TTT[i], dt)
  vi_df <- returned_df[[1]]
  min_vi_df <- returned_df[[2]]
  
  if (TT < num_steps) {
    padding <- rbind(data.frame(),rep(-.Machine$double.xmax, num_steps - TT))
    padding <- padding[rep(seq_len(nrow(padding)), each=NN),]
    vi_df <- as.data.frame(do.call(cbind,list(padding, vi_df)))
    min_vi_df <- as.data.frame(do.call(cbind,list(padding, min_vi_df)))    
  } 
  
  names(vi_df) <- names(v_df)
  names(min_vi_df) <- names(min_v_df)
  v_df_[[i]] <- vi_df
  min_v_df_[[i]] <- min_vi_df
}

v_df <- dplyr::bind_rows(v_df_)
rm(v_df_)
min_v_df <- dplyr::bind_rows(min_v_df_)
rm(min_v_df_)

################################################################################

# Unconditional expected number of purchases.
EXt_uncond_B <- function(v, uv, lambda) {
  lambda_ <- lambda*dt
  e_df <- lambda_*(min_v_df > uv - v)*(v_df > -v)
  e_df <- as.numeric(apply(e_df, MARGIN=2, sum)/NN)
  return(e_df)
}

################################################################################
# Full Heterogeneous model (heterogeneous v with stochastic starting point and lambda with gamma distribution and uv stead of c)

num_sample_points <- 100

C <- c(0.164078997765089, -0.933513496541919, 0.153271457784792, 10.3108946744492)

sample_v <- c(7.13720126193948, 10.2238979400136, 7.49597621499561, 7.50569379539229,
              7.18730436055921, 3.8663922669366, 1.07285407022573, 10.9597547259182,
              12.1122561267111, 2.72072376217693, 6.54472685535438, 3.49708598689176,
              9.19208584818989, 1.49582108482718, 3.76035970752127, 6.68615782284178,
              11.4044801937416, 9.92076971218921, 10.7349454087671, 0.739916724851355,
              5.31245431280695, 9.53822925221175, 10.6766388821416, 0.171052812365815,
              1.52512885630131, 14.9357167014387, 0.351895397761837, 10.2751337690279,
              1.2036546645686, 10.9039172146004, 1.53357302653603, 0.0735185004305094,
              8.90127816237509, 12.0527442754246, 12.990284326952, 3.47540950868279,
              9.99291821848601, 5.09043989237398, 1.03900327929296, 4.49263473507017,
              8.7231546943076, 0.784267511917278, 14.8369204695337, 11.2060338025913,
              1.53958291746676, 11.0273514711298, 11.6367834771518, 13.6870931228623,
              14.7973999043461, 14.528372248169, 13.5573915811256, 3.96596173988655,
              2.9387904109899, 12.6298406906426, 14.9522504454944, 9.3964993476402,
              1.27641429542564, 14.4396325084381, 3.58587417053059, 10.8667156950105,
              5.13850679271854, 13.1689949997235, 1.68923649354838, 0.0433677015826106,
              2.4745819112286, 10.0202490482479, 0.518755627563223, 5.50950618227944,
              10.2066323684994, 14.7106074972544, 2.76616023620591, 7.32604239718057,
              11.023651646683, 4.04849799466319, 0.531205603620037, 10.5719935172237,
              14.6841580769978, 3.3569122350309, 2.90026302449405, 4.32511754217558,
              7.98159257392399, 3.83351788739674, 4.11937577300705, 2.59253523079678,
              6.42042906023562, 3.81501762662083, 14.2969897238072, 12.8209733613767,
              4.34527621488087, 13.7613824056461, 12.1309254330117, 4.26229657139629,
              6.39668103656732, 8.32342522102408, 3.5106775991153, 2.22841741866432,
              6.00406610174105, 9.49397004442289, 2.42312253685668, 13.437351572793)

sample_lambda <- c(0.140555103309453, 0.58494367916137, 0.152061105938628, 0.538590834010392,
                   0.461030945181847, 0.513353197369725, 0.5659702681005, 0.84105627448298,
                   0.710389111191034, 0.390465783886611, 0.465262437006459, 0.39724030578509,
                   0.26102451630868, 0.236271303379908, 0.580386436311528, 0.143074790714309,
                   0.581496251979843, 0.588644138304517, 0.224104268010706, 0.245935294078663,
                   0.490825387416407, 0.821494305506349, 0.0703488651197404, 0.115425863536075,
                   0.925369435222819, 0.739441704703495, 0.600309837376699, 0.53426411212422,
                   0.555669031804428, 0.895066541386768, 0.858686776831746, 0.579684223979712,
                   0.165503344731405, 0.316273862496018, 0.0345178509596735, 0.215697749285027,
                   0.367810460738838, 0.409888820489869, 0.0214630579575896, 0.607413431163877,
                   0.257724018301815, 0.94451712933369, 0.887699117651209, 0.413100291276351,
                   0.831062626326457, 0.12133949669078, 0.398235511267558, 0.693501035217196,
                   0.484576417598873, 0.689768523676321, 0.333759644534439, 0.12977625685744,
                   0.876496590906754, 0.76721339370124, 0.209656664635986, 0.000362426741048694,
                   0.0509776417165995, 0.444497337797657, 0.321338830050081, 0.122982134344056,
                   0.871424932731315, 0.0314744568895549, 0.52174011990428, 0.343335914891213,
                   0.511416089721024, 0.112242203671485, 0.800337044522166, 0.379967038519681,
                   0.935223913285881, 0.745186195941642, 0.310218111379072, 0.288515453692526,
                   0.739404360996559, 0.523198594572023, 0.310040414799005, 0.100403350312263,
                   0.92810521600768, 0.27272280305624, 0.976653260411695, 0.64409016049467,
                   0.972828670637682, 0.5450317079667, 0.966206596232951, 0.0501550044864416,
                   0.447661128127947, 0.694567354628816, 0.228449807036668, 0.333632431225851,
                   0.111259415047243, 0.0615503578446805, 0.451742341043428, 0.0180644183419645,
                   0.982072587590665, 0.811868412885815, 0.195480178110301, 0.246389716863632,
                   0.174116576788947, 0.479228511219844, 0.820034346776083, 0.420130068436265)

sample_uv <- rep(C[2], num_sample_points)

P_v <- function(v, uv, lambda, v0) {
  if ((v < uv) | (v0 < uv)) {
    return(0)
  }
  particular_soln <- (1/sigma)*sqrt(lambda/2)*exp(-sqrt(2*lambda)*abs(v-v0)/sigma)
  a1 <- (exp(2*sqrt(2*lambda)*max(uv,0)/sigma)/(sigma-sqrt(2*lambda)*min(uv,0)))*sqrt(lambda/2)
  a2 <- 2*sqrt(2*lambda)*(v0-uv)*((1-sign(v0))/2)/sigma
  a3 <- (1 + sqrt(2*lambda)*sign(v0)*min(uv,0)/sigma)*exp(-sqrt(2*lambda)*abs(v0)/sigma)
  A <- a1*(a2-a3)
  gen_soln <- A*exp(-sqrt(2*lambda)*v/sigma)
  
  #cheap_gen_soln <- -(1/sigma)*sqrt(lambda/2)*exp(-sqrt(2*lambda)*abs(v+v0-2*uv)/sigma)
  
  soln <- particular_soln + gen_soln
  
  return(soln)
}

P_lambda <- function(lambda, r, alpha) {
  val <- (alpha^r)*(lambda^(r-1))*exp(-lambda*alpha)/gamma(r)
  return(val)
}

print("Pre-compute the probability vector")
P_vec <- rep(0, num_sample_points)
for (i in 1:num_sample_points) {
  P_vec[i] <- P_v(sample_v[i], sample_uv[i], sample_lambda[i], C[1])*P_lambda(sample_lambda[i], C[3], C[4])
}

################################################################################
# Full Heterogeneous model (heterogeneous v with stochastic starting point and lambda with gamma distribution)

num_sample_points <- 200

#C <- c(0.1,0.508279947943678,0.8,20)
#C <- c(0.01,0.3,0.01,49)
#C <- c(0.922877402462614, 0.530546656576583, 0.567524543464434, 28.6567229840404)
#C <- c(2.02716773919088, 0.08177888241166, 0.173215038220269, 20.108539412836)
#C <- c(2.02325124713597, 0.0897965137218653, 0.176004121504952, 20.0894362854947)
#C <- c(1.67408177923126, 0.0821368391771925, 0.385299255957176, 18.7196197833521)
#C <- c(2.09407770586707, 0.0558690260176269, 0.513830768871799, 13.6147798922145)
#C <- c(1.79667508989251, 0.0826114892040001, 0.0521901467652249, 11.0384973513345)
#C <- c(1.71745828407736, 1e-04, 0.553, 10.58)

#C <- c(0.490383634183538, -1.0256549960035, 0.122693802949891, 10.0106216946594)
#C <- c(0.909266922011551, -0.931255556710074, 0.0207296215257242, 12.8457915516191)

P_v <- function(v, uv, lambda, v0) {
  if ((v < uv) | (v0 < uv)) {
    return(0)
  }
  particular_soln <- (1/sigma)*sqrt(lambda/2)*exp(-sqrt(2*lambda)*abs(v-v0)/sigma)
  a1 <- (exp(2*sqrt(2*lambda)*max(uv,0)/sigma)/(sigma-sqrt(2*lambda)*min(uv,0)))*sqrt(lambda/2)
  a2 <- 2*sqrt(2*lambda)*(v0-uv)*((1-sign(v0))/2)/sigma
  a3 <- (1 + sqrt(2*lambda)*sign(v0)*min(uv,0)/sigma)*exp(-sqrt(2*lambda)*abs(v0)/sigma)
  A <- a1*(a2-a3)
  gen_soln <- A*exp(-sqrt(2*lambda)*v/sigma)
  
  #cheap_gen_soln <- -(1/sigma)*sqrt(lambda/2)*exp(-sqrt(2*lambda)*abs(v+v0-2*uv)/sigma)
  
  soln <- particular_soln + gen_soln
  
  return(soln)
}

P_lambda <- function(lambda, r, alpha) {
  val <- (alpha^r)*(lambda^(r-1))*exp(-lambda*alpha)/gamma(r)
  return(val)
}

C <- c(0.697301375189045, -2.88964437986363, 0.392193766159119, 19.8472813975261) # good result? with r = 1, output file = Brownian_lowrc/slurm-28638327.out
#C <- c(0.743549195653551, -2.87411460914769, 0.292491104410643, 19.8683612837935)
#C <- c(0.706858804576217, -2.81462222884426, 0.224832883293576, 19.8747005420003)

#C <- c(0.589697578571773, -2.86689187729988, 0.219100626533936, 19.8596284614822)

#C <- c(0.697301375189045, -3.379774, 0.392193766159119, 19.8472813975261) # Counterfactual studies.
#C <- c(1.045952, -2.88964437986363, 0.392193766159119, 19.8472813975261) # Counterfactual studies.

#C <- c(0.589697578571773, -2.86689187729988, 0.219100626533936, 19.8596284614822)


sample_v <- c(0.773395114811137, 5.51823433837853, 3.26167005579919, 12.026479630731,
              14.0034884330817, 11.377408298431, 3.53258965420537, 9.7953331656754,
              1.03316146298312, 4.11616688710637, 7.53666533972137, 14.4966303720139,
              14.2144088353962, 4.60875745047815, 5.01729645766318, 6.92830784479156,
              13.679052782245, 10.8299085195176, 9.38310769968666, 14.8868675564881,
              10.8882546715904, 2.11537606897764, 7.12312591960654, 13.9557074778713,
              13.1812609964982, 9.34394070412964, 11.0273661499377, 10.0169758487027,
              2.82914949464612, 10.0968886585906, 0.553244138136506, 3.22195638553239,
              8.24595014797524, 14.9533457960933, 9.64696808019653, 12.9519532585982,
              14.9500529340003, 3.72396443621255, 5.6025135400705, 12.1320319839288,
              6.44604705506936, 1.47788247093558, 10.9675354266074, 3.79665139247663,
              5.01665957272053, 4.15853122947738, 8.09711758629419, 11.9577210315038,
              14.3883298896253, 6.66617801995017, 4.67849762295373, 5.86131123709492,
              0.748267042217776, 11.8694011552725, 13.2860379049089, 3.65411929087713,
              12.4966848653276, 2.17808011570014, 4.13465558085591, 13.0258886783849,
              14.6977156796493, 12.5795014598407, 14.713460089406, 1.01786527549848,
              8.32038767519407, 13.8059474097099, 6.94979692460038, 10.4090430575889,
              8.72176079079509, 2.37931007752195, 1.6717486793641, 7.80689190840349,
              5.07385652046651, 8.82957576191984, 9.50135428458452, 2.93019606499001,
              12.3058738326654, 13.1326375762001, 14.2944467696361, 7.3322074895259,
              8.81834131549112, 5.72378181503154, 5.26949345832691, 9.70092113711871,
              12.0897173357662, 2.54818336805329, 13.7539094255771, 6.58991970238276,
              13.9231240481604, 6.77996269776486, 12.5025409623049, 9.79022440966219,
              12.9535217920784, 12.1869032399263, 4.9643183068838, 14.484330075793,
              8.6389619554393, 14.0252247091848, 13.9669359731488, 10.0636359932832,
              3.96410651039332, 1.11654797801748, 7.1233709785156, 14.8186848289333,
              8.4605671162717, 14.0065615600906, 6.65005139540881, 13.6063331610058,
              1.53921901714057, 9.41459626425058, 9.16335589718074, 11.0721531871241,
              14.2079554894008, 2.47415474848822, 9.19138787314296, 1.75230489461683,
              10.3488673560787, 2.91338818031363, 10.7083081360906, 7.39544197102077,
              13.0655521235894, 1.75683336798102, 2.46553981443867, 4.4240130437538,
              13.3154701441526, 14.5822258398402, 7.15090394136496, 14.3722087412607,
              1.36257692473009, 9.24397574504837, 13.8000195741188, 1.89274551579729,
              14.4797630875837, 1.81933956337161, 0.104722918476909, 0.728089779149741,
              11.3846770499367, 3.81970194750465, 10.0750595214777, 4.51251212507486,
              12.1225641283672, 4.08224310376681, 9.78553559049033, 12.8833274706267,
              0.413870194461197, 9.17689147288911, 0.395853538066149, 4.0140537545085,
              3.12490988988429, 9.44335940759629, 6.12800719449297, 8.70225074118935,
              10.3474508598447, 10.799492856022, 12.6583824085537, 0.70920335361734,
              11.3693516969215, 14.868645707611, 13.9405201084446, 12.3062485666014,
              3.19599001435563, 8.77255637431517, 4.09948291140608, 7.87537869298831,
              7.38911931286566, 2.73658790742047, 5.6559421797283, 11.3627046940383,
              6.93998685688712, 6.28286913852207, 6.96941800648347, 5.80855274456553,
              9.44531097309664, 2.76464223163202, 7.12833961704746, 10.7568159629591,
              11.8344249681104, 1.72759399632923, 12.4578582833055, 0.41388826793991,
              10.5370021169074, 4.48651309241541, 14.3758657691069, 1.11193540273234,
              13.7969714845531, 1.93259864347056, 8.39422021410428, 6.26732889795676,
              9.72123138955794, 14.6175871964078, 6.55017259530723, 12.937250820687,
              8.68708810536191, 9.71256589866243, 8.65891171968542, 8.60729655018076,
              8.27578565455042, 10.4056992265396, 6.80893631419167, 10.977491409285)

sample_lambda <- c(0.685295628150925, 0.524533801712096, 0.513961545191705, 0.205576573032886,
                   0.316045571351424, 0.171596145723015, 0.51223022933118, 0.320223944727331,
                   0.508400801103562, 0.335510130506009, 0.756420037010685, 0.288455079076812,
                   0.328457705676556, 0.110885615693405, 0.514461618382484, 0.883035372709855,
                   0.302886501187459, 0.994387048529461, 0.263317487901077, 0.579933770233765,
                   0.470102443825454, 0.0570952964480966, 0.0139189676847309, 0.0671389130875468,
                   0.84482044656761, 0.131116523873061, 0.295166296185926, 0.419927153736353,
                   0.27563615818508, 0.119739730842412, 0.0300246207043529, 0.682712926529348,
                   0.81089652585797, 0.149418055778369, 0.772070619277656, 0.056529184570536,
                   0.785818117205054, 0.242483457783237, 0.93470539804548, 0.418799663893878,
                   0.889034810243174, 0.329407720826566, 0.911350788781419, 0.692819541553035,
                   0.347276315558702, 0.438890763791278, 0.335350005421788, 0.0296893406193703,
                   0.0465421725530177, 0.280167021788657, 0.581007023341954, 0.989759563235566,
                   0.0327121850568801, 0.462485596071929, 0.834043571958318, 0.194624674506485,
                   0.231662523234263, 0.227399092633277, 0.966397380689159, 0.768063905416057,
                   0.998717583715916, 0.274012678069994, 0.616476257797331, 0.965854706242681,
                   0.226871553109959, 0.629158539697528, 0.970825708471239, 0.491840912727639,
                   0.739244815194979, 0.153735738014802, 0.777293533785269, 0.602523326640949,
                   0.317582216113806, 0.556380774127319, 0.750585563713685, 0.534460620488971,
                   0.223124605370685, 0.561600901884958, 0.3290586466901, 0.132930608000606,
                   0.544134454568848, 0.64592501684092, 0.633772618370131, 0.76788640092127,
                   0.74926318321377, 0.652755832765251, 0.00953536084853113, 0.74790216004476,
                   0.654999587452039, 0.148094350006431, 0.556747068651021, 0.44671824015677,
                   0.374539733165875, 0.0500805000774562, 0.786104690050706, 0.553079142002389,
                   0.381490986561403, 0.481079438468441, 0.835497152525932, 0.626924729673192,
                   0.846243407810107, 0.43796048918739, 0.301781960530207, 0.0856657726690173,
                   0.616910221753642, 0.118005697615445, 0.956903268350288, 0.13703727722168,
                   0.13974245195277, 0.415412486996502, 0.884126174030825, 0.688635450322181,
                   0.818737848429009, 0.390046489657834, 0.885341444518417, 0.171531500993297,
                   0.443103467812762, 0.818357565905899, 0.986961144953966, 0.89328247262165,
                   0.0489113414660096, 0.244614642113447, 0.153146984288469, 0.792325305519626,
                   0.927232511807233, 0.00916835432872176, 0.535857529146597, 0.765383832389489,
                   0.977358356816694, 0.794880585744977, 0.659598926547915, 0.760237926151603,
                   0.477381481090561, 0.621595251373947, 0.929641046095639, 0.165850933641195,
                   0.221124191535637, 0.378087595105171, 0.0613579403143376, 0.909945865860209,
                   0.110222659772262, 0.826997470343485, 0.965124491136521, 0.49126475234516,
                   0.93802160769701, 0.293630329426378, 0.220367837930098, 0.857231108238921,
                   0.0293482125271112, 0.395686159608886, 0.767798001412302, 0.24205255554989,
                   0.518862440250814, 0.0307877347804606, 0.7040888981428, 0.0197018352337182,
                   0.534341987920925, 0.384019812569022, 0.0794651005417109, 0.290586970048025,
                   0.90120127145201, 0.926142692100257, 0.332915576640517, 0.783631427912042,
                   0.742419369053096, 0.45836979104206, 0.640216623432934, 0.868667581118643,
                   0.362292398698628, 0.533720667241141, 0.988822383573279, 0.439149852609262,
                   0.349274213658646, 0.273833075771108, 0.149327145656571, 0.632428423734382,
                   0.894064476713538, 0.418796831276268, 0.0595508343540132, 0.543815910350531,
                   0.901426865486428, 0.211872841697186, 0.557494023581967, 0.341427452163771,
                   0.464103598147631, 0.808015966787934, 0.946670086821541, 0.703273633029312,
                   0.0588582032360137, 0.480189963942394, 0.675346424104646, 0.508347294759005,
                   0.386148748453707, 0.0372101808898151, 0.722868401790038, 0.808446818031371,
                   0.621624490246177, 0.0593952334020287, 0.983567130984738, 0.11030936287716)

# min_sample_v <- 0
# max_sample_v <- 15
# min_sample_lambda <- 0
# max_sample_lambda <- 1
# sample_v <- runif(num_sample_points, min=min_sample_v, max=max_sample_v)
# sample_lambda <- runif(num_sample_points, min=min_sample_lambda, max=max_sample_lambda)

UV_fn <- function(uc, lambda) {
  #r <- 0.00183
  r <- 1
  #r <- 16.01211
  #r <- 960.7266
  val_ <- sigma/(sqrt(2*r))
  if (uc <= val_*log(val_*lambda)) {
    val <- uc - val_*log(val_*lambda)
  } else {
    val <- exp(uc/val_)/lambda - val_
  }
  return(val)
}

sample_uv <- c()
for (i in 1:length(sample_lambda)) {
  sample_uv[i] <- UV_fn(C[2], sample_lambda[i])
}

print("Pre-compute the probability vector")
P_vec <- rep(0, num_sample_points)
for (i in 1:num_sample_points) {
  P_vec[i] <- P_v(sample_v[i], sample_uv[i], sample_lambda[i], C[1])*P_lambda(sample_lambda[i], C[3], C[4])
}

################################################################################
# Full Heterogeneous model (heterogeneous v with normal distribution and lambda with gamma distribution)

num_sample_points <- 100

#C <- c(0.0467546416113259, 0.266801568308382, 0.510296815611335, 0.797240750736448, 20.0026856708002)
#C <- c(0.144488291265844, 0.474251735014832, 0.509674590661066, 0.773104014358862, 20.0244990854034)
#C <- c(0.139496337251289, 0.462743870231239, 0.512526779937397, 0.771152124031799, 20.0248562350546)
#C <- c(0.412055578172972, 1.11394650935658, 0.534019446294555, 0.472289311810907, 20.1319943751653)
C <- c(0.412055578171445, 1.05824918388481, 0.534019446294306, 0.449624846223484, 20.1319943751644)

P_v <- function(v, mv, sv) {
  return(dnorm(v, mean=mv, sd=sv))
}

P_lambda <- function(lambda, r, alpha) {
  val <- (alpha^r)*(lambda^(r-1))*exp(-lambda*alpha)/gamma(r)
  return(val)
}

sample_v <- rep(0.01 + (0:19)/4, 5)
sample_lambda <- 0.0647020255861506 + floor((0:99)/20)/10

# Numerically solve for uv given c and lambda:
UV_fn <- function(c, lambda) {
  r <- 0.00183
  val_ <- lambda*sigma/((2^(3/2))*sqrt(r))
  if (c <= val_) {
    val <- sigma*log(c/val_)/sqrt(2*r)
  } else {
    val <- optim(fn=function(uv) { 
      return(((lambda/r)*max(uv, 0) - c/r + lambda*sigma*exp(-sqrt(2*r)*abs(uv)/sigma)/((2*r)^(3/2)))^2) 
    }, par=c(1), method="BFGS")$par
  }
  return(val)
}

sample_uv <- c()
for (i in 1:length(sample_lambda)) {
  sample_uv[i] <- UV_fn(C[3], sample_lambda[i])
}

print("Pre-compute the probability vector")
P_vec <- rep(0, num_sample_points)
for (i in 1:num_sample_points) {
  P_vec[i] <- P_v(sample_v[i], C[1], C[2])*P_lambda(sample_lambda[i], C[4], C[5])
}

################################################################################
# Two levels lambda heterogeneous model (gamma distribution for v)

num_sample_points <- 200

#C <- c(0.00728797644352207, 0.234366118823102, 0.565184940935866, 0.071633413136171, 0.143082485265971, 0.0442832601980781)
C <- c(0.0355984386059243, 0.243003551101419, 0.508279947943678, 0.0647020255861506, 0.139601467725088, 0.0659422715552434)

sample_v <- rep(c(3.24239281471819, 1.92852606298402, 2.84325709566474, 4.9252844194416,
                  3.76555447583087, 4.75572058465332, 4.55351010314189, 3.96502395160496,
                  4.98264966765419, 2.65206836746074, 0.743875093758106, 0.0956122321076691,
                  1.81114426581189, 1.29848030861467, 2.20018447260372, 2.6693958370015,
                  0.542226273100823, 1.62437596358359, 1.24375816318206, 0.954295124392956,
                  0.687611578032374, 2.60179164586589, 1.07815001392737, 1.13642374868505,
                  2.39591674064286, 2.95202919398434, 3.51172660011798, 3.86620663339272,
                  1.58719330327585, 0.24205747875385, 0.288625617977232, 3.9843015128281,
                  3.56188141508028, 1.05197056545876, 0.170275074196979, 2.25677340524271,
                  1.81813652045093, 2.43341428111307, 2.07904122187756, 2.05156543524936,
                  0.872484154533595, 2.10959001793526, 3.82140196161345, 3.15547402948141,
                  4.90395012777299, 1.00094908382744, 4.97277746093459, 1.38218699721619,
                  3.59816948883235, 2.5261653913185, 3.07809975231066, 3.27946304460056,
                  4.81044317129999, 4.96254692785442, 0.600845320150256, 2.92643711087294,
                  0.386988949030638, 0.112575967796147, 1.19877966470085, 0.159906215267256,
                  4.37840960454196, 2.86626894492656, 1.96826112340204, 4.90811535622925,
                  1.56990329385735, 3.13028925214894, 1.91492799669504, 4.71601514378563,
                  2.35118160839193, 1.41137271304615, 4.15554350242019, 1.47455002996139,
                  3.05678957724012, 1.94429307593964, 2.57428789162077, 2.9578090866562,
                  4.43016987643205, 2.85588731407188, 0.577519219368696, 0.949254625011235,
                  4.52260388061404, 0.876898712012917, 2.64900111942552, 1.50352274766192,
                  3.43151607434265, 0.53916570963338, 3.16711377468891, 3.47994603565894,
                  3.07852565310895, 0.593629211653024, 0.0736125628463924, 2.40732491365634,
                  2.38616264658049, 0.124630919890478, 2.2695879638195, 2.23135726409964,
                  3.29700356465764, 4.46792261675, 4.75798050058074, 4.55740422476083),2)

sample_lambda <- c(rep(C[4], num_sample_points/2), rep(C[4] + C[5], num_sample_points/2))
sample_c <- rep(C[3], num_sample_points)

# Numerically solve for uv given c and lambda:
UV_fn <- function(c, lambda) {
  r <- 0.00183
  val_ <- lambda*sigma/((2^(3/2))*sqrt(r))
  if (c <= val_) {
    val <- sigma*log(c/val_)/sqrt(2*r)
  } else {
    val <- optim(fn=function(uv) { 
      return(((lambda/r)*max(uv, 0) - c/r + lambda*sigma*exp(-sqrt(2*r)*abs(uv)/sigma)/((2*r)^(3/2)))^2) 
    }, par=c(1), method="BFGS")$par
  }
  return(val)
}

sample_uv <- c(rep(UV_fn(C[3],C[4]), num_sample_points/2), rep(UV_fn(C[3],C[4] + C[5]), num_sample_points/2))

P_v <- function(v, mv, sv) {
  return(dnorm(v, mean=mv, sd=sv))
}

P_lambda <- function(lambda, lambda_low, lambda_high, p) {
  thres <- 1e-10
  if (abs(lambda - lambda_high) < thres) {
    return(p)
  } else if (abs(lambda - lambda_low) < thres) {
    return(1-p)
  } else {
    return(0)
  }
}

print("Pre-compute the probability vector")
P_vec <- rep(0, num_sample_points)
for (i in 1:num_sample_points) {
  P_vec[i] <- P_v(sample_v[i], C[1], C[2])*P_lambda(sample_lambda[i], C[4], C[4] + C[5], C[6])
}

################################################################################
# Heterogeneous in v and lambda with uv instead of c

num_sample_points <- 100

C <- c(1.19287617394177, -2.22587325395563, 0.89804663567774, 15.9652968367141)

sample_v <- c(1.63076030556113, 1.42081345897168, 2.68825458362699, 1.06559204054065,
              3.95796011551283, 1.00841492065229, 3.796194747556, 2.43219825904816,
              2.61813346529379, 3.02485328516923, 3.43551122932695, 1.55090690008365,
              0.838049890007824, 2.56427840562537, 3.49159787292592, 0.608711276436225,
              2.36602609278634, 0.330150100635365, 4.70250926911831, 3.92280973610468,
              1.28950280719437, 1.37559716473334, 3.43849578057416, 3.49009718396701,
              4.9638585082721, 1.31130766123533, 0.0549933465663344, 1.59406274091452,
              3.07059792452492, 0.346484758192673, 1.92892825347371, 3.30411816365086,
              0.961321883369237, 2.93252034112811, 3.36642194888555, 4.37974460772239,
              4.63446655659936, 3.46932601649314, 3.11514775152318, 2.32613084837794,
              3.86331608053297, 4.97527729021385, 0.0898273894563317, 1.45666957017966,
              4.74006540840492, 2.24720311933197, 1.72384787001647, 0.43220670777373,
              2.14526715455577, 0.0480428792070597, 1.78293628618121, 2.67457612324506,
              0.416301870718598, 4.60215834784321, 1.28381164278835, 1.49615809204988,
              2.05636704922654, 2.28984813787974, 3.11342773376964, 3.23056360823102,
              2.30288973194547, 4.56947694416158, 3.87036816799082, 1.40560614992864,
              0.276656143832952, 3.18975281785242, 4.21321097644977, 1.07850864296779,
              0.787914445390925, 3.51926943985745, 4.03823834960349, 2.28094829362817,
              2.83186048036441, 3.18338227691129, 1.22427805210464, 3.84543856955133,
              3.48418980021961, 1.1993874842301, 0.902973493793979, 4.72006158321165,
              1.46367806009948, 4.46121163433418, 0.483547660987824, 3.68800515425391,
              3.53580831433646, 0.716547989286482, 1.55134237371385, 2.44714239030145,
              3.77476818975993, 0.459822666598484, 2.10980731411837, 3.86190376477316,
              0.933758304454386, 2.20210900646634, 1.37067251023836, 3.28628741088323,
              1.10666309134103, 1.7896493722219, 3.82018655305728, 2.05353630939499)

sample_lambda <- c(0.184568778378889, 0.247649414232001, 0.479294002056122, 0.18742071907036,
                   0.626555798109621, 0.965259582269937, 0.125338526908308, 0.284472210565582,
                   0.129373387200758, 0.9712840388529, 0.120655856328085, 0.0504707696381956,
                   0.862425170140341, 0.364076743833721, 0.120689725968987, 0.171556766843423,
                   0.701648371992633, 0.302433780161664, 0.360838222783059, 0.138580456143245,
                   0.34695363859646, 0.316736877895892, 0.0515786726027727, 0.569239754462615,
                   0.0184761493001133, 0.108390801120549, 0.449769010301679, 0.398104301886633,
                   0.106803265400231, 0.488401491660625, 0.518087928183377, 0.00733225722797215,
                   0.295162350637838, 0.302074242150411, 0.688690076582134, 0.930093942210078,
                   0.190792606212199, 0.328962031751871, 0.304114262573421, 0.473321036202833,
                   0.883828061632812, 0.746598243713379, 0.981876422883943, 0.978300262242556,
                   0.0910913571715355, 0.139194839866832, 0.00164437829516828, 0.296292378567159,
                   0.383865190204233, 0.476781149627641, 0.0521963285282254, 0.0636385686229914,
                   0.445114843547344, 0.548564800526947, 0.026791081763804, 0.462110358290374,
                   0.495860942173749, 0.581489593023434, 0.334958199644461, 0.80626315344125,
                   0.769743368960917, 0.581611787201837, 0.973857208155096, 0.614755548071116,
                   0.0202703594695777, 0.508693655719981, 0.0241557527333498, 0.863478661281988,
                   0.237471646629274, 0.747444362379611, 0.375557094812393, 0.46460406598635,
                   0.199026279849932, 0.604309330927208, 0.521087244153023, 0.240768992342055,
                   0.402396495221183, 0.111759891500697, 0.773453035159037, 0.850902524311095,
                   0.229466974502429, 0.464666888816282, 0.121511974139139, 0.219643314601853,
                   0.83743141614832, 0.629812734667212, 0.935145837487653, 0.757250766269863,
                   0.258385443128645, 0.612292520701885, 0.642175579210743, 0.0444105847273022,
                   0.237502862466499, 0.446041788905859, 0.211729276925325, 0.809561612783,
                   0.345832022605464, 0.119239167543128, 0.838425514288247, 0.25203553121537)

sample_uv <- rep(C[2], num_sample_points)

P_v <- function(v, betav) {
  val <- exp(-v/betav)/betav
  return(val)
}

P_lambda <- function(lambda, r, alpha) {
  val <- (alpha^r)*(lambda^(r-1))*exp(-lambda*alpha)/gamma(r)
  return(val)
}

print("Pre-compute the probability vector")
P_vec <- rep(0, num_sample_points)
for (i in 1:num_sample_points) {
  P_vec[i] <- P_v(sample_v[i], C[1])*P_lambda(sample_lambda[i], C[3], C[4])
}

################################################################################
# Heterogeneous model (heterogeneous in v only)

num_sample_points <- 20

#C <- c(0.169837695174262, -0.102753503356024, 0.0165482069500899)
#C <- c(-0.380493040847759, -0.412353717894576, 0.0484241946077642)
C <- c(-0.355908529591659, -0.357239390331844, 0.0580481626172486)

#sample_v <- 0.01 + (0:19)/2
sample_v <- 0.01 + (0:19)/(4/3)

sample_lambda <- rep(C[3], num_sample_points)
sample_uv <- rep(C[2], num_sample_points)

P_v <- function(v, uv, lambda, v0) {
  if ((v < uv) | (v0 < uv)) {
    return(0)
  }
  particular_soln <- (1/sigma)*sqrt(lambda/2)*exp(-sqrt(2*lambda)*abs(v-v0)/sigma)
  a1 <- (exp(2*sqrt(2*lambda)*max(uv,0)/sigma)/(sigma-sqrt(2*lambda)*uv))*sqrt(lambda/2)
  a2 <- 2*sqrt(2*lambda)*(v0-uv)*((1-sign(v0))/2)/sigma
  a3 <- (1 + sqrt(2*lambda)*sign(v0)*uv/sigma)*exp(-sqrt(2*lambda)*abs(v0)/sigma)
  A <- a1*(a2-a3)
  gen_soln <- A*exp(-sqrt(2*lambda)*v/sigma)
  
  #cheap_gen_soln <- -(1/sigma)*sqrt(lambda/2)*exp(-sqrt(2*lambda)*abs(v+v0-2*uv)/sigma)
  
  soln <- particular_soln + gen_soln
  
  return(soln)
}

print("Pre-compute the probability vector")
P_vec <- rep(0, num_sample_points)
for (i in 1:num_sample_points) {
  P_vec[i] <- P_v(sample_v[i], sample_uv[i], sample_lambda[i], C[1])
}

################################################################################

tol_predict_txns_B <- rep(0, num_steps)
for (i in 1:num_sample_points) { 
  print(paste("Computing point i = ", i))
  tol_predict_txns_B <- tol_predict_txns_B + EXt_uncond_B(sample_v[i], sample_uv[i], sample_lambda[i])*P_vec[i]
}
tol_predict_txns_B <- tol_predict_txns_B/sum(P_vec)
dput(tol_predict_txns_B)
print(sum(tol_predict_txns_B)*sum(P_vec)) 
# In counterfactual studies we can only compute txns relative to to the txns of the fitted model. 
# This is because by *1/sum(P_vec) we assumed no one drops out (between the time of initial valuation and the time of first purchase). 
# This is fine for the fitted model, since we basically 'normalize' the parameters this way.
# In counterfactual studies, if parameters change, there might be more people dropping out, i.e. we have less number of people even making
# their first purchase, so *1/sum(P_vec) would mislead the result. 